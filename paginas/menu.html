<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Red RPG Evolution – Menú</title>
  <!-- hoja de estilos del menú -->
  <link rel="stylesheet" href="../estilos/menu.css" />
</head>
<body class="menu">
  
  <!-- Barra superior -->
  <header class="menu-topbar">
    <div class="menu-brand"></div>
    
    <nav class="menu-actions">
      <button id="btnLogout" class="btn">Cerrar sesión</button>
    </nav>
  </header>
  
  <!-- Contenido principal -->
  <main class="menu-hero" aria-label="Menú principal">
    <section class="menu-card menu-profile" aria-live="polite">
      <h2>Tu perfil</h2>
      <p><strong id="nombreJugador">…</strong></p>
      <p>Mejor puntaje: <strong id="mejorPuntaje">0</strong></p>
    </section>
    
    <section class="menu-card menu-play">
      <h2>¿Listo para jugar?</h2>
      <p>Atrapa el 🧀, esquiva la 💩. ¡Suerte!</p>
      <a class="btn primary" href="./juego.html?play=1">Jugar ahora</a>
    </section>
  
    <section class="menu-card menu-links">
      <h2>Objetivos</h2>
      <div class="menu-grid">
        <!-- ► Objetivo 1 -->
        <div class="btn block ghost objetivo" id="obj-100" aria-disabled="true">
          <strong>100 puntos</strong><br>
          Avanza más profundo en la alcantarilla
        </div>

        <!-- ► Objetivo 2 -->
        <div class="btn block ghost objetivo" id="obj-200" aria-disabled="true">
          <strong>200 puntos</strong><br>
          Llega al laboratorio ☣️
        </div>

        <!-- ► Objetivo 3 -->
        <div class="btn block ghost objetivo" id="obj-500" aria-disabled="true">
          <strong>500 puntos</strong><br>
          Viaja por el portal 🌍
        </div>
      </div>
    </section>

  </main>
  
  <footer class="menu-footer">
    © <span id="anio"></span> Red RPG Evolution — Menú
  </footer>
  
  <!-- ========== [MENÚ: sesión, perfil y objetivos] ========== -->
  <script type="module">
    /* ===== Imports del proyecto ===== */
    import { getUser, signOut, getPerfil } from "../javascript/conecciones.js";

    /* ===== DOM ===== */
    const nombreJugadorEl = document.getElementById("nombreJugador");
    const mejorPuntajeEl  = document.getElementById("mejorPuntaje");
    const btnLogout       = document.getElementById("btnLogout");
    document.getElementById("anio").textContent = new Date().getFullYear();

    /* ========== [OBJETIVOS: helpers locales] ========== */
    // ► Pone en verde y quita 'ghost'
    function marcarObjetivo(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add("completado");
      el.classList.remove("ghost");
      el.setAttribute("aria-disabled", "false");
    }
    // ► Marca según puntaje
    function actualizarObjetivos(puntos){
      if (puntos >= 100) marcarObjetivo("obj-100");
      if (puntos >= 200) marcarObjetivo("obj-200");
      if (puntos >= 500) marcarObjetivo("obj-500");
    }
    // ► Fallback local
    function leerMaxLocal(){
      const v = parseInt(localStorage.getItem("maxPuntos") || "0", 10);
      return Number.isFinite(v) ? v : 0;
    }

    /* ========== [MENÚ: flujo principal] ========== */
    const user = await getUser();
    if (!user) {
      window.location.href = "./login.html";
    } else {
      // Nombre base
      let nombre = user.user_metadata?.nombre || (user.email ? user.email.split("@")[0] : "Jugador");

      // Leer perfil de DB
      let scoreDB = 0;
      try {
        const { data, error } = await getPerfil(user.id);
        if (!error && data) {
          if (data.nombre) nombre = data.nombre;
          if (typeof data.mejor_puntaje === "number") scoreDB = data.mejor_puntaje;
        }
      } catch(e) {
        console.warn("getPerfil falló:", e);
      }

      // Usar máximo entre DB y localStorage
      const mejor = Math.max(scoreDB, leerMaxLocal());

      // Pintar UI
      nombreJugadorEl.textContent = nombre;
      mejorPuntajeEl.textContent  = String(mejor);
      actualizarObjetivos(mejor);
    }

    /* ========== [MENÚ: logout] ========== */
    btnLogout.addEventListener("click", async () => {
      await signOut();
      window.location.href = "../index.html";
    });
  </script>

</body>
</html>
