<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rata Atrapa ‚Äì Login / Registro</title>
  <!-- üß© Usa el mismo CSS global -->
  <link rel="stylesheet" href="../estilos/principal.css" />
</head>
<body>
  <!-- ==========================================================
       PANEL DE AUTENTICACI√ìN (login/registro)
       ========================================================== -->
  <main id="authView" class="panel auth">
    <!-- Tabs -->
    <div class="tabs">
      <button id="tabLogin" class="btn active" type="button">Iniciar sesi√≥n</button>
      <button id="tabRegistro" class="btn" type="button">Registrarme</button>
      <a class="btn ghost" style="margin-left:2%" href="../index.html">Inicio</a>
    </div>

    <!-- Form: Login -->
    <form id="formLogin" class="form auth-form" autocomplete="on">
      <label>Correo
        <input id="loginEmail" type="email" required placeholder="tu@correo.com" />
      </label>
      <label>Contrase√±a
        <input id="loginPass" type="password" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </label>
      <button class="btn grande" type="submit">Entrar</button>
    </form>

    <!-- Form: Registro -->
    <form id="formRegistro" class="form auth-form oculto" autocomplete="off">
      <label>Nombre para mostrar
        <input id="regNombre" type="text" required placeholder="RataPro" />
      </label>
      <label>Correo
        <input id="regEmail" type="email" required placeholder="tu@correo.com" />
      </label>
      <label>Contrase√±a
        <input id="regPass" type="password" required minlength="6" placeholder="m√≠n. 6 caracteres" />
      </label>
      <button class="btn grande" type="submit">Crear cuenta</button>
    </form>

    <!-- Mensajes -->
    <p id="authMsg" class="msg" aria-live="polite"></p>
  </main>

  <!-- ==========================================================
       L√ìGICA DE LOGIN/REGISTRO (solo para esta p√°gina)
       ========================================================== -->
  <script type="module">
    import {
      getUser, signInWithEmail, signUpWithEmail,
      tryHandleAuthRedirect, resendSignup
    } from "../javascript/conecciones.js";

    /* ---------- DOM ---------- */
    const tabLogin = document.getElementById("tabLogin");
    const tabRegistro = document.getElementById("tabRegistro");
    const formLogin = document.getElementById("formLogin");
    const formRegistro = document.getElementById("formRegistro");
    const authMsg = document.getElementById("authMsg");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const regNombre = document.getElementById("regNombre");
    const regEmail  = document.getElementById("regEmail");
    const regPass   = document.getElementById("regPass");

    /* ---------- Tabs ---------- */
    tabLogin.addEventListener("click", () => {
      tabLogin.classList.add("active");
      tabRegistro.classList.remove("active");
      formLogin.classList.remove("oculto");
      formRegistro.classList.add("oculto");
      authMsg.textContent = "";
    });
    tabRegistro.addEventListener("click", () => {
      tabRegistro.classList.add("active");
      tabLogin.classList.remove("active");
      formRegistro.classList.remove("oculto");
      formLogin.classList.add("oculto");
      authMsg.textContent = "";
    });

    /* ---------- Submit: Login ---------- */
    formLogin.addEventListener("submit", async (e) => {
      e.preventDefault();
      authMsg.textContent = "Ingresando...";
      let timeout = setTimeout(() => {
        authMsg.textContent = "‚ö†Ô∏è Sin respuesta del servidor. Revisa tu conexi√≥n o CORS.";
      }, 10000);
      try {
        const { error } = await signInWithEmail(loginEmail.value, loginPass.value);
        clearTimeout(timeout);
        if (error) { authMsg.textContent = "‚ö†Ô∏è " + error.message; return; }
        authMsg.textContent = "‚úÖ ¬°Bienvenido!";
        // Ir al men√∫
        window.location.href = "./menu.html";
      } catch (e2) {
        clearTimeout(timeout);
        authMsg.textContent = "‚ö†Ô∏è Error inesperado al iniciar sesi√≥n.";
      }
    });

    /* ---------- Submit: Registro ---------- */
    formRegistro.addEventListener("submit", async (e) => {
      e.preventDefault();
      authMsg.textContent = "Creando cuenta...";
      const nombre = regNombre.value.trim();
      try {
        const { error } = await signUpWithEmail(regEmail.value, regPass.value, nombre);
        if (error) { authMsg.textContent = "‚ö†Ô∏è " + error.message; return; }
        authMsg.textContent = "‚úÖ Revisa tu correo para confirmar.";
      } catch (e2) {
        authMsg.textContent = "‚ö†Ô∏è Error inesperado al registrarte.";
      }
    });

    /* ---------- Manejo de redirects (confirmaci√≥n por email, OAuth/PKCE) ---------- */
    try {
      const r = await tryHandleAuthRedirect?.();
      if (r?.redirectError) {
        if (r.redirectError.code === "otp_expired") {
          authMsg.textContent = "‚ö†Ô∏è Tu enlace de verificaci√≥n caduc√≥ o ya fue usado.";
          // Bot√≥n para reenviar verificaci√≥n
          let btn = document.getElementById("btnResendVerify");
          if (!btn) {
            btn = document.createElement("button");
            btn.id = "btnResendVerify";
            btn.type = "button";
            btn.className = "btn grande";
            btn.textContent = "Reenviar verificaci√≥n";
            authMsg.insertAdjacentElement("afterend", btn);
            btn.addEventListener("click", async () => {
              const mail = regEmail.value || loginEmail.value || prompt("Escribe tu correo:") || "";
              if (!mail) return;
              authMsg.textContent = "Enviando verificaci√≥n...";
              const { error } = await resendSignup(mail.trim());
              authMsg.textContent = error ? ("‚ö†Ô∏è " + error.message) : "‚úÖ Enlace reenviado. Revisa tu correo.";
            });
          }
        } else {
          authMsg.textContent = `‚ö†Ô∏è ${r.redirectError.code}: ${r.redirectError.description}`;
        }
      }
    } catch {}

    /* ---------- Si ya hay sesi√≥n, ir al men√∫ ---------- */
  /* ---------- Forzar login SIEMPRE (aunque exista sesi√≥n) ---------- */
  // Si llegamos de un callback de verificaci√≥n/PKCE, muestra un mensaje amistoso
  const fromCallback = location.hash.includes("access_token") || location.search.includes("code=");

  // Si ya hay sesi√≥n, cerrarla para obligar a iniciar sesi√≥n/registrarse
  const existing = await getUser();
  if (existing) {
    await signOut();
    authMsg.textContent = fromCallback
      ? "‚úÖ Correo verificado. Ahora inicia sesi√≥n."
      : "üîí Por seguridad, inicia sesi√≥n para jugar.";
    // Mostrar la pesta√±a de login por defecto
    if (typeof tabLogin !== "undefined") tabLogin.click();
  }


  </script>
</body>
</html>
